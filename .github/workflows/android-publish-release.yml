name: Android Publish Release

on:
  push:
    branches: [main]
    paths:
      - 'android/**'

defaults:
  run:
    working-directory: android

jobs:
  check-release:
    name: Check if Release Commit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      is_release: ${{ steps.check.outputs.is_release }}
      version_name: ${{ steps.extract.outputs.version_name }}
      version_code: ${{ steps.extract.outputs.version_code }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Check commit message
        id: check
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          if [[ "$COMMIT_MSG" == release:* ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract version
        id: extract
        if: steps.check.outputs.is_release == 'true'
        run: |
          BUILD_GRADLE="app/build.gradle.kts"
          VERSION_NAME=$(grep -oP 'versionName\s*=\s*"\K[^"]+' "$BUILD_GRADLE")
          VERSION_CODE=$(grep -oP 'versionCode\s*=\s*\K\d+' "$BUILD_GRADLE")
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT

  build-release:
    name: Build Release APKs
    needs: check-release
    if: needs.check-release.outputs.is_release == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Check if tag exists
        run: |
          TAG="v${{ needs.check-release.outputs.version_name }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag $TAG already exists"
            exit 1
          fi

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@e50d5f73bfe71c2dd0aa4218de8f4afa59f8f81d # v16

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@87b14cf437d03d37989d87f0fa5ce4f5dc1a330b # v8

      - name: Enable unprivileged user namespaces for bwrap
        run: |
          # buildFHSEnv uses bubblewrap which requires user namespaces
          sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0 || true

      - name: Cache Gradle wrapper
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/.gradle/wrapper/dists
          key: gradle-wrapper-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties') }}

      - name: Cache Gradle dependencies and build
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.gradle/caches
            android/.gradle
          key: gradle-build-${{ runner.os }}-${{ hashFiles('android/**/*.gradle.kts', 'android/gradle.properties') }}
          restore-keys: |
            gradle-build-${{ runner.os }}-

      - name: Build debug APK
        run: |
          nix develop ..#android --command android-fhs-env -c '
            ./gradlew assembleDebug --no-daemon --stacktrace
          '

      - name: Build release APK
        run: |
          nix develop ..#android --command android-fhs-env -c '
            ./gradlew assembleRelease --no-daemon --stacktrace
          '

      - name: Decode keystore
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > release.keystore

      - name: Sign release APKs
        if: env.KEYSTORE_BASE64 != ''
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          nix develop ..#android --command android-fhs-env -c '
            for apk in app/build/outputs/apk/release/*.apk; do
              if [[ -f "$apk" ]]; then
                jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
                  -keystore release.keystore \
                  -storepass "$KEYSTORE_PASSWORD" \
                  -keypass "$KEY_PASSWORD" \
                  "$apk" "$KEY_ALIAS"
              fi
            done
          '
          rm -f release.keystore

      - name: Rename APKs
        run: |
          VERSION="${{ needs.check-release.outputs.version_name }}"

          mkdir -p release-apks

          # Debug APK
          if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
            cp app/build/outputs/apk/debug/app-debug.apk "release-apks/Alicia-v${VERSION}-debug.apk"
          fi

          # Release APKs (may have multiple for different ABIs)
          for apk in app/build/outputs/apk/release/*.apk; do
            if [[ -f "$apk" ]]; then
              basename=$(basename "$apk" .apk)
              # Extract ABI from filename if present (e.g., app-arm64-v8a-release)
              if [[ "$basename" =~ app-(.+)-release ]]; then
                abi="${BASH_REMATCH[1]}"
                cp "$apk" "release-apks/Alicia-v${VERSION}-${abi}.apk"
              else
                cp "$apk" "release-apks/Alicia-v${VERSION}-release.apk"
              fi
            fi
          done

          ls -la release-apks/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: v${{ needs.check-release.outputs.version_name }}
          name: Alicia Android v${{ needs.check-release.outputs.version_name }}
          draft: true
          prerelease: true
          generate_release_notes: true
          files: release-apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ needs.check-release.outputs.version_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version Code | ${{ needs.check-release.outputs.version_code }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | v${{ needs.check-release.outputs.version_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### APKs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for apk in release-apks/*.apk; do
            echo "- $(basename "$apk")" >> $GITHUB_STEP_SUMMARY
          done
