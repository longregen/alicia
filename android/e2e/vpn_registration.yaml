appId: com.alicia.assistant
name: VPN Auto-Provision Flow
---
# Tests the auto-provisioning VPN flow.
# Assumes onboarding is complete (runs after onboarding.yaml).
# Requires:
#   - Mock Alicia API running on port 8181 (started by run-maestro-tests.sh)
#   - Headscale running on port 8080
#   - api_url_override.txt pushed to app filesDir
#
# The Go network monitor needs a nudge via onDNSConfigChanged to detect the
# emulator's network (Go's net.Interfaces fails on Android 11+ netlink).
# VpnManager.init calls notifyNetworkAvailable to handle this.

# Force-stop and relaunch so the app picks up the API URL override
- stopApp
- launchApp
- assertVisible: "Tap to speak"
- takeScreenshot: screenshots/vpn_01_main_before

- tapOn:
    id: "com.alicia.assistant:id/settingsButton"
- takeScreenshot: screenshots/vpn_02_settings

- tapOn:
    id: "com.alicia.assistant:id/vpnSettingsCard"
- assertVisible: "VPN Settings"
- takeScreenshot: screenshots/vpn_03_vpn_settings

# Tap Connect before provisioning â€” should show "Set up VPN first" toast
- tapOn:
    id: "com.alicia.assistant:id/connectButton"
- assertVisible: "Set up VPN first"
- takeScreenshot: screenshots/vpn_03b_not_provisioned

# Tap the auto-provision button
- tapOn:
    id: "com.alicia.assistant:id/provisionButton"

# VPN permission dialog appears because provisioning starts the VPN service
- tapOn:
    text: "OK"
    optional: true
- takeScreenshot: screenshots/vpn_04_provisioning

# Wait for provisioning to complete (credentials saved toast)
- extendedWaitUntil:
    visible:
      text: "Credentials saved"
    timeout: 60000
- takeScreenshot: screenshots/vpn_05_provisioned

# After provisioning, the exit node section should be visible
- scrollUntilVisible:
    element:
      text: "Exit Node"
    direction: DOWN
    timeout: 5000
- takeScreenshot: screenshots/vpn_06_exit_nodes

# Navigate back to main screen
- pressKey: back
- pressKey: back
- assertVisible: "Tap to speak"
- takeScreenshot: screenshots/vpn_07_main_after
